# MQTT 
Message Queuing Telemetry Transport 消息队列遥测传输协议协议，是物联网常用的应用层下跌一，运行在TCP/IP中的应用层
## MQTT 通信模型
MQTT提供一对多的消息发布/订阅模型，即发布者可以向多个订阅者发布消息，订阅者也可以订阅多个发布者的消息。该模醒是基于C/S模型，协议中主要有三种身份：发布者，服务器，订阅者。在MQTT中，发布者和订阅者都是客户端而服务器是服务端
- 客户端功能
    1. 发布消息给其他相关的客户端
    2. 订阅主题请求接收相关应用详细
    3. 取消订阅主题请求移除接收应用消息
    4. 从服务端终止连接
- 服务端功能
    1. 接受来自客户端的网络连接请求
    2. 接收客户端发布的应用消息
    3. 处理客户端的订阅和取消订阅请求
    4. 转发应用消息给复合条件的已在订阅客户端
## 消息主题与服务质量
MQTT协议支持消息主题，即发布者和订阅者可以指定消息的主题，使得消息可以被多个订阅者接收。服务质量（QoS）是指消息的可靠性，MQTT协议支持3种服务质量：
- 最多一次（QoS0）：消息发布者发送消息后，最多一次地将消息发送给订阅者，但不保证消息一定会被接收。
- 至少一次（QoS1）：消息发布者发送消息后，至少一次地将消息发送给订阅者，但不保证消息一定会被接收。
- 只有一次（QoS2）：消息发布者发送消息后，只有一次地将消息发送给订阅者，且保证消息一定会被接收。
## MQTT 控制报文
MQTT控制报文有3个部分组成，分别是固定爆殴、可变包头、有效荷载；其中固定报头是所有的MQTT控制报文都包含的，可变报头与有效载荷是部分MQTT控制报文包含
### 固定报头
固定报头由两个部分组成，首字节和剩余长度
|部分|长度|说明|
|----|----|----|
|首字节|1Byte|包含报文类型和标志位各4bits|
|剩余长度|1~4Byte|报文长度，表示报文剩余部分长度（不包含报文本身）|
- 固定报头类型
    |类型|值|说明|
    |----|--|----|
    |Reserved|0|保留|
    |CONNECT|1|连接请求|
    |CONNACK|2|连接确认|
    |PUBLISH|3|发布消息|
    |PUBACK|4|发布确认| 
    |PUBREC|5|发布收到|
    |PUBREL|6|发布释放|
    |PUBCOMP|7|发布完成| 
    |SUBSCRIBE|8|订阅请求|
    |SUBACK|9|订阅确认|
    |UNSUBSCRIBE|10|取消订阅|
    |UNSUBACK|11|取消订阅确认|
    |PINGREQ|12|PING请求|
    |PINGRESP|13|PING响应|
    |DISCONNECT|14|断开连接|
    |Reserved|15|保留|
- 标志位
    - bit3是控制报文是否重复分发标志
    - bit2-1是服务器质量等级
    - bit0是保留标志位
- 剩余长度字段，使用变长编码方案，用于记录剩余报文长度的，表示当前的消息剩余的字节数，它可以是1~4个字节，每个字节只有7位用于存储数据，最高位的bit7用于指示是否还有更多的字节，所以一个MQTT报文理论上可以上传256M的报文
    |剩余长度范围|	固定报头总长度|
    |:---------:|:-------------:|
    |0 ~ 127|	2 字节|
    |128 ~ 16,383|	3 字节|
    |16,384 ~ 2,097,151|	4 字节|
    |2,097,152 ~ 268,435,455|	5 字节|
### 可变报头
可变报头位于固定报头之后，根据报文类型不同而结构不同，它可以携带该报文所需的控制信息，但是`PINGREQ、PINGRESP、DISCONNECT`等报文没有可变报头；可变报头的内容会根据报文类型的不同而不同，但可变报头的报文标识符字段存在于多个类型的报文里，有一些报文又没有报文标识符，除了没有可变包头的三种报头类型，`CONNECT和CONNACK`不需要报文表示符字段，报文标识符是一个16位的双字节无符号整数，范围从1到65535。0是保留值，不能使用。
### 几个常见的报文的可变报头
#### CONNECT 连接报文
在一个MQTT会话中，CONNECT报文是唯一的，CONNECT报文包含以下字段：
1. `Protocol Name` 协议名称，固定为MQTT，长度为4字节
2. `Protocol Level` 协议级别，目前版本为4，长度为1字节
3. `Connect Flags` 连接标志，包含以下字段：
    - `Username Flag` 用户名标志，0表示不包含用户名，1表示包含用户名
    - `Password Flag` 密码标志，0表示不包含密码，1表示包含密码
    - `Will Retain` 遗嘱消息保留标志，0表示遗嘱消息不保留，1表示遗嘱消息保留
    - `Will QoS` 遗嘱消息服务质量，0表示最多一次，1表示至少一次，2表示只有一次
    - `Will Flag` 遗嘱消息标志，0表示不包含遗嘱消息，1表示包含遗嘱消息
    - `Clean Session` 清除会话标志，0表示保留会话，1表示清除会话
    - `Reserved` 保留位，必须为0
4. `Keep Alive` 保持连接时间，表示客户端和服务端之间的连接保持时间，单位为秒，范围1~65535
#### CONNACK 连接确认报文
CONNACK报文用于服务端向客户端确认连接请求，包含以下字段：
1. `Connect Acknowledge Flags` 连接确认标志，包含以下字段：
    - `Session Present` 会话存在标志，0表示当前连接没有会话，1表示当前连接有会话
    - `Reserved` 保留位，必须为0
2. `Return Code` 返回码，表示连接是否成功，包含以下值：
    - `0` 连接成功
    - `1` 连接已存在
    - `2` 连接Refused，无效的协议版本
    - `3` 连接Refused，服务端不可用
    - `4` 连接Refused，认证失败
    - `5` 连接Refused，未授权
#### PUBLISH 发布消息报文
PUBLISH报文将应用程序消息从发布者发送到服务端或者从服务端发送到订阅者，包含以下字段：
1. `Topic Name` 主题名称，主题名称的最大长度为65535字节
2. `Packet Identifier` 报文标识符，用于唯一标识PUBLISH报文，范围1~65535，只有QoS1和QoS2的PUBLISH报文才有报文标识符
3. `Application Message` 应用程序消息，最大长度为268,435,455字节

### 有效载荷
有效载荷是MQTT控制报文中的可选部分，包含与报文类型相关的应用数据  
## MQTT 使用流程
